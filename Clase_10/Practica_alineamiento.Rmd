---
title: "Introducción al análisis de secuencias NGS  - Alineamiento"
subtitle: 'Curso Genética y Genómica en Producción Animal'
author:
 name: Dr. José A. Gallardo, Dr(c) Margarita Rivera.
 affiliation: Pontificia Universidad Católica de Valparaíso
 email: <jose.gallardo@pucv.cl>
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
  word_document: default
  pdf_document: default
---

<style>
#TOC {
  color: black;
  font-familiy: Calibri;
  font-size: 14px;
  border-color: #708090; 
}
body {
   color: black;
   font-familiy: Calibri;
}

pre {
  color: black;
  background-color: #F8F8FF;
}
# header {
  color: #800000;
  font-familiy: Calibri;
  background-color: #F5F5F5;
  opacity: 0.8;
  font-size: 16px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## INTRODUCCIÓN

El paso de alineación de secuencias se considera una parte integral que contribuye directamente a las identificaciones de ADN, ARN o proteínas (Pham-Quoc, Kieu-Do, & Thinh, 2019). El problema del mapeo de reads consiste en ubicar o alinear dentro de un genoma de referencia previamente secuenciado los millones de reads para luego ensamblarlas a un nuevo genoma (Bak, Bodziony, Migdałek, Pareek, & Żukowski§, 2020). Esta carga de trabajo se la realiza con diferentes enfoques de alineación, sin embargo, al igual que cualquier software, cada enfoque presenta diferentes formas de ejecución y consecuentemente de análisis.

Como se explicó, para averiguar el nivel de similitud entre una gran cantidad de datos genómicos se presenta un desafío computacional para los softwares de alineación y por ello, se han desarrollado varios programas que ayudan en esta tarea, como lo son, BWA (Li & Durbin, 2009), Bowtie 2 (JHU, 2016) y otros, cuya función principal es hacer coincidir secuencias cortas provenientes de NGS con secuencias de referencia (Bak, Bodziony, Migdałek, Pareek, & Żukowski§, 2020). De hecho, BWA es un software muy popular para fines de alineamiento, debido a su compatibilidad con datos de Illumina y la integración de distintos algoritmos de alineamiento con mayor rendimiento para reads de distintas longitudes (Li & Durbin, 2009).

En este tutorial se realiza el alineamiento de las secuencias previamente filtradas en la práctica de "Control de calidad". Las muestras biológicas provienen de la cepa Aquagen de _Salmo salar_

### FORMATO SAM

![Formato SAM](https://user-images.githubusercontent.com/80792310/121112439-05d97c00-c7d6-11eb-8816-961022673034.png)


### SOFTWARES DE BIOINFORMÁTICA

**BWA**

Es un algoritmo de alineación para alinear lecturas de secuencia o secuencias de consulta largas con un genoma de referencia grande como el humano. Elige automáticamente entre alineaciones locales y de extremo a extremo y admite lecturas de extremos emparejados (Li, 2013).

Puedes visualizar las opciones y más información de bwa [Aquí](http://bio-bwa.sourceforge.net/bwa.shtml)

**Samtools**

Es un conjunto de utilidades que manipulan alineaciones en los formatos SAM (Sequence Alignment / Map), BAM y CRAM. Convierte entre los formatos, clasifica, fusiona e indexa, y puede recuperar lecturas en cualquier región rápidamente, puedes tener más información sobre este programa [Aquí](https://www.htslib.org/doc/samtools.html)

## PRÁCTICA ALINEAMIENTO DE SECUENCIAS

### 1 - CONECTAR A SERVIDOR POMEO

Conecte al servidor pomeo usando la siguiente dirección IP: **200.54.220.141** puerto 22.

Para Windows puede conectarse con el software PuTTy y las claves de acceso dadas en la primera clase.


### 2 - CONFIGURAR BIOCONDA E INSTALAR PROGRAMAS PARA ANÁLISIS

Para configurar el canal bioconda se debe ejecutar el siguiente comando

    conda config --add channels bioconda
    
Instalar los software bwa
   
    conda install -c bioconda bwa
        
Instalar samtools
    
    conda install -c bioconda samtools
    
    conda config --add channels bioconda 

    conda config --add channels conda-forge 

    conda install samtools==1.11


### 3 - VERIFICAR DIRECTORIOS DE INSTALACIÓN 

Si deseas constatar la ruta de instalación de un programa determinado puedes colocar el comando "whereis" en la terminal más el programa del que desea obtener la ruta.

     whereis sratoolkit 
     whereis samtools
     whereis bwa 

La salida de cada comando indicará la ruta de instalación como sigue, para cada programa del que desees obtener información.

    /home2/usuario/miniconda3/bin/bwa
     
### 4 - CREACIÓN DE DIRECTORIO DE TRABAJO Y DESCARGA DE DATOS PARA ALINEAMIENTO

Considerando que nuestras secuencias fastq originales tuvieron muy buena calidad, puedes trabajar directamente con ellas. Para ambos casos debes trasladar los archivos a una nueva carpeta, así:

Crear una carpeta denominada en tu usuario de home2

    mkdir alineamiento

Ingresa a tu carpeta "alineamiento" y transfiere los archivos de clase anterior colocando los siguientes comandos en la terminal:

    mv /home2/usuario/SRA_samples/SRR2006763/SRR2006763_1.fastq /home2/usuario/alineamiento/
    mv /home2/usuario/SRA_samples/SRR2006763/SRR2006763_2.fastq /home2/usuario/alineamiento/

Lista tu carpeta de alineamiento para verificar que tienes lo necesario para el alineamiento, hasta ahora deben constar tus dos secuencias "SRR2006763_1.fastq" y "SRR2006763_2.fastq"
    
    ls 

Ahora descargaremos el genoma de referencia de la mitocondria de _Salmo salar_ en la misma carpeta de alineamiento, para ello:

En tu navegador entra al siguiente link

[genoma_mitocondria](https://www.ncbi.nlm.nih.gov/genome/?term=salmo+salar)

Encontrarás una tabla con el listado del genoma de referencia donde se incluyen todos los cromosomas y el genoma de la mitocondria y a cuyo identificardor RefSeq darás clic, como se ve en la siguiente imagen

![Listado genoma _Salmo salar_](https://user-images.githubusercontent.com/80792310/122309216-83d30c80-ced3-11eb-9627-385f1a5018ee.png)


Dar clic en la opción FASTA localizada bajo el título e identificador RefSeq de la referencia

![Fasta option](https://user-images.githubusercontent.com/80792310/122309259-99483680-ced3-11eb-81d9-b2738c1cc93c.png)

Enviar la secuencia FASTA del genoma mitocondrial a un archivo

![Genoma mitocondrial](https://user-images.githubusercontent.com/80792310/122309294-a9601600-ced3-11eb-9657-06f39cf839cc.png)


Ve al lugar de descargas de tu computador y encontrarás el archivo denominado "sequence.fasta" al que debes renombrar como "mt.fasta" y subirlo a POMEO, para ello puedes trabajar con WINSCP o iniciando sesión online en el servidor

    http://200.54.220.141:8787/auth-sign-in

Si trabajas con WINSCP debes iniciar sesión, guardar tus datos y conectarte como se indica en la siguiente imagen

![WINSCP](https://user-images.githubusercontent.com/80792310/122308313-c398f480-ced1-11eb-9abc-c5dbb7aeb67e.png)

Al conectar debes ingresar nuevamente tu contraseña y aparecerá la interfaz de tu servidor con las carpetas que tienes creadas, aquí ingresarás en tu carpeta de alineamiento y arrastrarás el archivo descagado del genoma mitocondrial a la misma.

Cuando termines lo anterior puedes ingresar a POMEO, listar tu carpeta de alineamiento con `ls` y verás tu archivo "mt.fasta" junto con tus secuencias fastq 

### 5 - INDEXACION DEL GENOMA DE REFERENCIA

Una vez que incluiste en tu carpeta de alineamiento todos los archivos descritos en pasos anteriores podemos proceder a la etapa inicial del alineamiento, que corresponde a la indexación del genoma de referencia con bwa:

    bwa index mt.fasta
    
La salida del comando dará como resultado 5 archivos con extensiones "amb","ann","bwt","pac" y "sa"

### 5 - ALINEAMIENTO

Para el alineamiento tendremos las siguientes etapas

- Alineamiento de las secuencias contra el genoma de referencia, cuya salida será un archivo con extensión ".sam"
- Conversión del archivo SAM a BAM
- Inspeccionar el archivo .sam de salida 
- Ordenar lecturas alineadas por posición
- Indexación con Samtools
  
Para ejecutar todas las etapas anteriores en ese orden se debe crear un script con nano 

    nano aln_mt.sh
    
En el script coloca las siguientes instrucciones

    #!/bin/bash -l
    bwa mem mt.fasta SRR2006763_1.fastq SRR2006763_2.fastq > SRR2006763.sam 
    samtools view -Sb -q 30 SRR2006763.sam > SRR2006763.bam 
    samtools sort SRR2006763.bam -o SRR2006763.sort.bam 
    samtools index SRR2006763.sort.bam 

Ejecuta tu script con bash

    bash aln_mt.sh

**Algunas observaciones adicionales**

- BWA-MEM se recomienda para secuencias de más de ~70 pb, ya que, generalmente BWA-MEM es más tolerante con los errores dadas las secuencias más largas. 
- Si quieres ver lo que sucede en cada etapa de alineamiento, puedes colocar en la terminal cada comando del script de forma individual, e.g.
   
   `bwa mem mt.fasta SRR2006763_1.fastq SRR2006763_2.fastq > SRR2006763.sam` # para alinear tus dos secuencias fastq al genoma mitocondrial
   `samtools view -Sb -q 30 SRR2006763.sam > SRR2006763.bam` # Transformar tu archivo sam a bam
   `samtools sort SRR2006763.bam -o SRR2006763.sort.bam` # ordenar tu archivo binario bam
   `samtools index SRR2006763.sort.bam` # indexar tu archivo bam

- Si quieres observar tu archivo sam puedes hacerlo con  
 
 `less SRR2006763.sam`

- El archivo bam no se puede visualizar
- Procura listar tu carpeta cada vez que realices un trabajo, una descarga, o ejecutes un script para comprobar tus salidas. Si quieres comprobar los tamaños de tus archivos al mismo tiempo que los listas, puedes hacerlo con 

 `ls -l -h`
    
### REFERENCIAS

Pham-Quoc, C., Kieu-Do, B., & Thinh, T. N. (2019). A high-performance FPGA-based BWA-MEM DNA sequence alignment. Wiley, 1-12.

Li, H., & Durbin, R. (2009). Fast and accurate short read alignment with Burrows-Wheeler Transform. Bioinformatics, 1754-60.
JHU. (2016). Johns Hopkins University. Obtenido de Manual of Bowtie 2 - Fast and sensitive read alignment: http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml




