---
title: "Introduccion a genomica poblacional y ancestria"
subtitle: 'Curso Genetica y Genomica en Produccion Animal'
author:
 name: Dr. Jose A. Gallardo, Nicol Delgado.
 affiliation: Pontificia Universidad Catolica de Valparaiso
 email: <jose.gallardo@pucv.cl>
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
  pdf_document: default
  word_document: default
---

<style>
#TOC {
  color: black;
  font-familiy: Calibri;
  font-size: 14px;
  border-color: #708090; 
}
body {
   color: black;
   font-familiy: Calibri;
}

pre {
  color: black;
  background-color: #F8F8FF;
}
# header {
  color: #800000;
  font-familiy: Calibri;
  background-color: #F5F5F5;
  opacity: 0.8;
  font-size: 16px;
}
</style>

```{r setup, include=FALSE, warning=FALSE, comment=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(readr)
library(dplyr)
library(tidyverse)
library(cowplot)
```

### FORMATO PLINK

![Estructura formato PLINK, tomado de: https://www.researchgate.net/figure/Overview-of-various-commonly-used-PLINK-files-SNP-single-nucleotide-polymorphism_fig3_323424714](https://www.researchgate.net/publication/323424714/figure/fig3/AS:667766705098757@1536219397189/Overview-of-various-commonly-used-PLINK-files-SNP-single-nucleotide-polymorphism.png)

### SOFTWARES DE BIOINFORMATICA

PLINK

PLINK es un conjunto de herramientas de analisis de asociación de genoma completo de codigo abierto y gratuito, disenado para realizar una variedad de análisis genéticos básicos a gran escala de forma eficiente (https://www.cog-genomics.org/plink2).

ADMIXTURE

ADMIXTURE es un software para estimar la maxima probabilidad de ancestria individual e inferir poblaciones a partir de un conjunto de datos de genotipos de multiples SNP. Utiliza el mismo modelo estadistico que el software STRUCTURE pero el algoritmo de optimizacion numerico que utiliza realiza estimaciones con mayor rapidez (https://bioinformaticshome.com/tools/descriptions/ADMIXTURE.html).

### LIBRERIAS R

Para elaborar algunas gráficas se usarán las siguientes librerías de R

**ggplot2**
**readr**
**dplyr**
**tidyverse**
**cowplot**

### Objetivos del trabajo practico

- Realizar un analisis de genomica poblacional y ancestria en _Salmo salar_ a partir de archivo de variantes VCF.


### Origen de las muestras

El archivo vcf contiene muestras provenientes de tres poblaciones domesticadas de salmon del Atlantico (*Salmo salar*) provenientes de Europa, Oceania y Norteamerica.

### Etapas del analisis poblacional

-Descarga del archivo vcf

-Estimacion de algunas medidas comunes de diversidad genetica

-Transformacion del archivo vcf a formato plink

-Transformacion del archivo plink a formato plink binario

-Filtrado por equilibrio de Hardy-Weinberg, frecuencia del alelo menor, desequilibrio de ligamiento e individuos emparentados

-Analisis y deteccion de estructura poblacional con PLINK o ADMIXTURE

-Visualizacion de la subestructura de la poblacion mediante graficas realizadas en R


### Actividades


### 1 - Conectar a servidor Pomeo

Conecte al servidor pomeo usando la siguiente direccion IP: **200.54.220.141** puerto 22.

Para MAC use la terminal y para Windows puede conectarse con el software PuTTy y las claves de acceso dadas en la primera clase.


### 2 - Configurar bioconda e instalar programas para analisis

Para configurar el canal bioconda se debe ejecutar el siguiente comando

    conda config --add channels bioconda
    
Instalar los software plink
   
    conda install -c bioconda plink
    
Instalar admixture

    conda install -c bioconda admixture


### 3 - Crear directorio de trabajo "population" y preparar archivos para el analisis poblacional con plink y admixture.

  Este directorio y los archivos necesarios para ejecutar esta practica ya fueron creados e instalados en su directorio personal. Por ahora solo es necesario que ingrese al directorio "population" y explore los archivos de trabajo.

3.1 -  Ingresar a su directorio de trabajo **population** con el comando **cd** y liste con **ls** los archivos que estan contenidos
 
    cd population
    ls -l -h

3.2 - El directorio **population** contiene los siguientes archivos necesarios para efectuar el analisis poblacional con plink y admixture.

**EU_OC_US.vcf**  
Archivo vcf que contiene las muestras provenientes de tres poblaciones de salmon del Atlantico (*Salmo salar*).  

**Europa**: 2_WG0341511-DNA_A02_5408, 3_WG0341511-DNA_A03_5416, 5_WG0341511-DNA_A05_5450.  

**Oceania**: FR07958834, FR07958842, FR07958850.  

**Norteamerica**: GNB12-1, GNB12-10, GNB12-11.  

Adicionalmente, contiene un Script para realizar los diagramas de admixture.

**Admixture_plot.R**  
Script que contiene el codigo para crear una funcion llamada admixtureplot (), utilizada para realizar los diagramas de admixture.


### 4 - Analisis de diversidad

4.1 - Estimar el numero de sitios heterocigotos para cada individuo y la heterocigosidad observada y esperada para cada marcador   
    
    vcftools --vcf EU_OC_US.vcf --het --out EU_OC_US
    
    vcftools --vcf EU_OC_US.vcf --hardy --out EU_OC_US
    
Utilice ls -l, head, cat, less, etc., segun corresponda, para explorar los archivos de salida de cada uno de estos analisis.

4.2 - Calcular la diversidad en una ventana no superpuesta de 200 kb para cada individuo de las tres poblaciones  

### Para la poblacion de Europa
    
    vcftools --vcf EU_OC_US.vcf --window-pi 200000 --indv 2_WG0341511-DNA_A02_5408 --indv 3_WG0341511-DNA_A03_5416 --indv 5_WG0341511-DNA_A05_5450 --out EU

### Para la poblacion de Oceania

    vcftools --vcf EU_OC_US.vcf --window-pi 200000 --indv FR07958834 --indv FR07958842 --indv FR07958850 --out OC

### Para la poblacion de Norteamerica

    vcftools --vcf EU_OC_US.vcf --window-pi 200000 --indv GNB12-1 --indv GNB12-10 --indv GNB12-11 --out US

4.3 - Calcular el desequilibrio de ligamiento (LD) para las tres poblaciones 

### Para la poblacion de Europa

    vcftools --vcf EU_OC_US.vcf --geno-r2 --chr 1 --ld-window-bp 100000 --min-r2 0.001 --indv 2_WG0341511-DNA_A02_5408 --indv 3_WG0341511-DNA_A03_5416 --indv 5_WG0341511-DNA_A05_5450 --out EU

### Para la poblacion de Oceania

    vcftools --vcf EU_OC_US.vcf --geno-r2 --chr 1 --ld-window-bp 100000 --min-r2 0.001 --indv FR07958834 --indv FR07958842 --indv FR07958850 --out OC

### Para la poblacion de Norteamerica
    
    vcftools --vcf EU_OC_US.vcf --geno-r2 --chr 1 --ld-window-bp 100000 --min-r2 0.001 --indv GNB12-1 --indv GNB12-10 --indv GNB12-11 --out US


```{r, warning=FALSE, message = FALSE}
EU <- read_delim("EU.geno.ld", delim = "\t")
OC <- read_delim("OC.geno.ld", delim = "\t")
US <- read_delim("US.geno.ld", delim = "\t")

EU$dist <- ceiling((EU$POS2 - EU$POS1)/1000)*1000
OC$dist <- ceiling((OC$POS2 - OC$POS1)/1000)*1000
US$dist <- ceiling((US$POS2 - US$POS1)/1000)*1000

EU2 <- group_by(EU,dist) %>%
  summarise(meanR2 = mean(`R^2`))

OC2 <- group_by(OC,dist) %>%
  summarise(meanR2 = mean(`R^2`))
  
US2 <- group_by(US,dist) %>%
  summarise(meanR2 = mean(`R^2`))  

dd <- bind_rows(EU2,OC2,US2)

dd$pop <- rep(c("EU","OC","US"),c(nrow(EU2),nrow(OC2),nrow(US2))) 

write_csv(dd,"EU_OC_US.windowed.ld.csv")
```


4.4 - Graficos de heterogocidad individual, diversidad de nucleotidos y LD

### Heterogocidad individual

```{r, warning=FALSE, message = FALSE}

het <- read_delim("EU_OC_US.het",delim = "\t")
het
het$Heterozygosity <- 1-(het$`O(HOM)`/het$N_SITES) 
het$Population <- c(rep("EU",3),rep("OC",3),rep("US",3))
A <- ggplot(het,aes(x = Population, y = Heterozygosity, col = Population)) +
  geom_point()+
  theme_bw()+
  theme(legend.position = "none")+
  xlab("")
A

```

### Diversidad de nucleotidos

```{r, warning=FALSE, message = FALSE}
pi_EU <- read_delim("EU.windowed.pi",delim = "\t")
pi_EU

pi_OC <- read_delim("OC.windowed.pi",delim = "\t")
pi_OC

pi_US <- read_delim("US.windowed.pi",delim = "\t")
pi_US

pi_all <- bind_rows(pi_EU,pi_OC,pi_US)
pi_all$Population<-c(rep("EU",nrow(pi_EU)),rep("OC",nrow(pi_OC)),rep("US",nrow(pi_US)))

B <- ggplot(pi_all,aes(x = Population, y = PI, col = Population))+
      geom_jitter(col = "grey",width = 0.1)+ 
      geom_boxplot(notch = T, alpha = 0,outlier.shape = NA)+ 
      theme_bw()+
      theme(legend.position = "none")+
      xlab("")+
      ylab(expression(pi))
B

```

### Desequilibrio de ligamiento

```{r, message = FALSE}
ld <- read_csv("EU_OC_US.windowed.ld.csv")
ld

C <- ggplot(ld,aes(x = dist/1000, y = meanR2, col = pop)) +
      geom_point()+
      geom_line()+
      theme_bw()+
      xlab("Distance (kb)")+
      ylab(expression(R^2))+
      scale_colour_discrete(name = "Population")
C

```


4.5 - Grafico de paneles multiples

```{r, message = FALSE}
library(cowplot)
top_row <- plot_grid(A,B,labels = "AUTO")
plot_grid(top_row,C,nrow = 2,labels = c("","C"))
```

### 5 - Analisis de estructura poblacional

5.1 - Generar el archivo de entrada en formato plink

    plink --vcf EU_OC_US.vcf --recode --out EU_OC_US --double-id --allow-extra-chr --chr-set 29

5.2 - Generar el archivo de entrada en formato plink binario

    plink --file EU_OC_US --make-bed --out EU_OC_US --allow-extra-chr --chr-set 29

5.3 - Filtrar basado en equilibrio de Hardy-Weinberg y frecuencia del alelo menor

    plink --bfile EU_OC_US --hwe 0.01 --maf 0.05 --make-bed --out EU_OC_US.Filtered --allow-extra-chr --chr-set 29

5.4 - Filtrar y excluir marcadores por desequilibrio de ligamiento

    plink --bfile EU_OC_US.Filtered --indep-pairwise 50 10 0.05 --make-bed --out EU_OC_US.Filtered --allow-extra-chr --chr-set 29
    
    plink --bfile EU_OC_US.Filtered --extract EU_OC_US.Filtered.prune.in --make-bed --out EU_OC_US.FilteredPruned --allow-extra-chr --chr-set 29

5.5 - Filtrar para remover individuos relacionados

    plink --bfile EU_OC_US.FilteredPruned --rel-cutoff 0.4 --out EU_OC_US.FilteredPruned --allow-extra-chr --chr-set 29
    
    plink --bfile EU_OC_US.FilteredPruned --keep EU_OC_US.FilteredPruned.rel.id --make-bed --out EU_OC_US.FilteredPrunedUnrel --allow-extra-chr --chr-set 29

5.6 - PCA (Principal Component Analysis)

    plink --bfile EU_OC_US.FilteredPrunedUnrel --pca 4 --out EU_OC_US.FilteredPrunedUnrel --allow-extra-chr --chr-set 29
    
5.7 - Graficos de PCA con R

```{r, message = FALSE}

pca1 <- read_delim("EU_OC_US.FilteredPrunedUnrel.eigenvec", delim = " ",col_names = F)
    head(pca1)

    colnames(pca1) <- c("Population","Individual",paste0("PC",c(1:4)))
    head(pca1)
  
    mycols <- c("#a6cee3",
              "#1f78b4",
              "#b2df8a",
              "#33a02c",
              "#fb9a99",
              "#e31a1c",
              "#fdbf6f",
              "#ff7f00",
              "#cab2d6")

    D <- ggplot(pca1,aes(x = PC1,y = PC2,col = Population))+
      geom_point()+
      theme_bw()+
      scale_colour_manual(values = mycols)
    D
```

    
### 6 - Analisis de admixture

6.1 Seleccion al azar del 1% de los marcadores

    plink --bfile EU_OC_US.FilteredPrunedUnrel --thin 0.01 --make-bed --out EU_OC_US.Thinned --allow-extra-chr --chr-set 29

6.2 - Analisis de ancestria de 2 a 6 poblaciones

    for K in `seq 2 6`;
    do
    admixture EU_OC_US.Thinned.bed $K;
    done

ADMIXTURE genera 2 archivos: .Q que contiene asignaciones de grupos para cada individuo y .P que contiene para cada SNP las frecuencias alelicas de la poblacion

6.3 - Graficos de ADMIXTURE para 2, 4 y 6 poblaciones

```{r, echo=TRUE, message = FALSE}
library(readr)
source("Admixture_plot.R")

    pops <- read_delim("EU_OC_US.Thinned.fam", delim = " ",col_names = F)

    K2 <- read_delim("EU_OC_US.Thinned.2.Q", delim = " ",col_names = F)
    E <- admixtureplot(str_out = K2,k = 2, pops = pops, xaxis = F)
    E

    K4 <- read_delim("EU_OC_US.Thinned.4.Q", delim = " ", col_names = F)
    G <- admixtureplot(str_out = K4,k = 4, pops = pops, xaxis = F)
    G

    K6 <- read_delim("EU_OC_US.Thinned.6.Q", delim = " ", col_names = F)
    H <- admixtureplot(str_out = K6,k = 6, pops = pops, xaxis = T)
    H
```

  
```{r, message = FALSE, echo=FALSE}

# 6.4 Grafico de paneles multiples
  # left_col <- plot_grid(D,nrow = 1)
  # 
  # right_col <- plot_grid(E,G,H,nrow = 3,rel_heights = c(0.5,0.5,1))
  # 
  # plot_grid(left_col,right_col,ncol = 2)

```


### 7 - REFERENCIAS

Marees A., de Kluiver H., Stringer S., Vorspan F., Curis E., Marie-Claire C., Derks E. (2018). A tutorial on conducting genome-wide association studies: Quality control and statistical analysis. International Journal of Methods in Psychiatric Research. 27. e1608. 10.1002/mpr.1608.

A PLINK tutorial: https://zzz.bwh.harvard.edu/plink/tutorial.shtml

Speciation & Population Genomics: a how-to-guide: https://speciationgenomics.github.io/ADMIXTURE/
