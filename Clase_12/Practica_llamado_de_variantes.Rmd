---
title: "Introducción al análisis de secuencias NGS  - Llamado de variantes"
subtitle: 'Curso Genética y Genómica en Producción Animal'
author:
 name: Dr. José A. Gallardo, Dr(c) Margarita Rivera.
 affiliation: Pontificia Universidad Católica de Valparaíso
 email: <jose.gallardo@pucv.cl>
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
  word_document: default
  pdf_document: default
---

<style>
#TOC {
  color: black;
  font-familiy: Calibri;
  font-size: 14px;
  border-color: #708090; 
}
body {
   color: black;
   font-familiy: Calibri;
}

pre {
  color: black;
  background-color: #F8F8FF;
}
# header {
  color: #800000;
  font-familiy: Calibri;
  background-color: #F5F5F5;
  opacity: 0.8;
  font-size: 16px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## INTRODUCCIÓN

Uno de los principales usos de la secuenciación de próxima generación es descubrir variaciones entre grandes poblaciones de muestras relacionadas (Danecek et al., 2011), con este fin, se han desarrollado tuberías que incluyen el procesamiento de grandes volúmenes de datos, y dentro de las cuales, constan los pasos de alineamiento y llamado de variantes. Uno de los softwares más empleados para realizar este último paso, es GATK, que se comprende como un kit de herramientas de análisis del genoma desarrollados por el Broad Institute, que tiene la capacidad de realizar gran parte del análisis requerido para llamar variantes genómicas (Deatherage, 2020).

Por otro lado, posterior al llamado de variantes se usan otros softwares en conjunto, que permiten realizar anotaciones de las mismas, como es el caso de SnpEff, que es una herramienta de predicción de efectos y anotaciones de variantes, como cambios de aminoácidos (Cingolani, y otros, 2012) o anotaciones de una variedad de modelos de genes codificantes y no codificantes de proteínas de una variedad de especies (Liu et al., 2015).

El presente trabajo tiene por objeto realizar el llamado de variantes y la anotación de una muestra secuenciada mediante el uso de GATK, Snpeff y otras herramientas de anotación y visualización de la región blanco.


### FORMATO VCF

![Estructura formato VCF, tomado de: https://www.slideshare.net/AmazonWebServices/dat311-largescale-genomic-analysis-with-amazon-redshift ](https://user-images.githubusercontent.com/80792310/122835931-e6068580-d2b6-11eb-8086-6149d46916fb.png)


### SOFTWARES DE BIOINFORMÁTICA

[GATK](https://gatk.broadinstitute.org/hc/en-us) O Genome Analysis Toolkit, es un software que presenta ciertas ventajas para el llamado de variantes, como, la integración de evidencia de variantes de múltiples muestras con genotipado conjunto, permite el uso de polimorfismos de un solo nucleótido (SNP) e Indels validados para mejorar la precisión de la llamada de variante y sus métodos se implementan de una manera susceptible a lecturas que se originan en una variedad de preparación de plantillas (McCormick, Truong, & Mullet, 2015). Sin embargo y aunque, como se ha visto, la precisión de esta tubería ya es alta, los falsos positivos (FP) siguen siendo inevitables, por lo que, después de la llamada de variantes, se recomienda filtrar los FP como parte de las buenas prácticas del software (Tan, Zhang, Yang, & Yin, 2020).

[PICARD TOOLS](https://broadinstitute.github.io/picard/) Es un conjunto de herramientas para manipular datos y formatos de secuenciación de alto rendimiento (HTS) como SAM / BAM / CRAM y VCF. El kit de herramientas de Picard es de código abierto y gratuito para todos los usos.

[HAPLOTYPECALLER](https://gatk.broadinstitute.org/hc/en-us/articles/360035531412-HaplotypeCaller-in-a-nutshell) Es una herramienta que contiene una serie de funciones  aplicadas al descubrimiento de variantes de la línea germinal de ADN.

### Objetivos del trabajo práctico

- Realizar el llamado de variantes de una secuencia de _Salmo salar_ obtenida por secuenciación de extremos emparejados 

### Origen de las muestras

- Las muestras SRR2009653.fastq_1, SRR2009653.fastq_2. Provienen de un set de 45 secuencias de salmón del atlántico  obtenidas por secuenciación de extremos emparejados con Illumina HiSeq2000 para analizar la resistencia a la necrosis pancreática infecciosa, con el fin de identificar polimorfismos que mostraban un gran contraste entre los grupos de genotipos.

### Etapas del llamado de variantes

- Descarga de secuencia y genoma de referencia
- Indexación del genoma de referencia
- Descarga, filtrado y alineamiento de secuencia de estudio (Secuencia sort.bam)
- Añadir grupos de lectura al archivo "bam"
- Indexación del archivo obtenido al añadir los grupos de lectura
- Identificación de variantes con HaplotypeCaller de GATK
- Visualización de archivo "vcf" generado en IGV

### Actividades

### 1 - Conectar a servidor Pomeo

Conecte al servidor pomeo usando la siguiente dirección IP: **200.54.220.141** puerto 22.

Para Windows puede conectarse con el software PuTTy y las claves de acceso dadas en la primera clase.


### 2 - Configurar bioconda e instalar programas para análisis

Para configurar el canal bioconda se debe ejecutar el siguiente comando

    conda config --add channels bioconda
    
Instalar los software bwa
   
    conda install -c bioconda gatk4
    
Instalar picard tools

    wget https://github.com/broadinstitute/picard/releases/download/2.8.1/picard.jar
        
En este tutorial también se utilizará Samtools (instalado en la clase anterior)


### 3 - Crear directorio de trabajo 

3.1 - Este directorio ya fue creado para usted

     mkdir variant_call
     
3.2 - Ingresar a su directorio de trabajo y listar
 
     ls 

3.3 - Constará de los siguientes archivos necesarios para efectuar el llamado de variantes

    "SRR2006763.sort.bam": previamente obtenido con las actividades aprendidas en clases anteriores.
    ref_genome.fna: genoma de referencia de _Salmo salar_
    ref_genome.fna.fai: archivo indexado del genoma de referencia
 
Para obtener los 3 archivos mencionados anteriormente se emplearon los siguiente comandos, puede probarlos posterior a la práctica por el tiempo que demoran en ejecutarse:

3.3.1 - Secuencia de estudio

La secuencia "SRR2006763.sort.bam" ordenada se obtuvo con los pasos de descarga, descompresión y alineamiento realizados en clases anteriores

3.3.2 - Genoma de referencia (ref_genome.fna) se aplicó el comando wget para efectuar la descarga desde NCBI**

    wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/233/375/GCF_000233375.1_ICSASG_v2/GCF_000233375.1_ICSASG_v2_genomic.fna.gz
 
3.3.3 - Para indexar el genoma de referencia (ref_genome.fna.fai) se aplicó el comando**

    samtools faidx ref_genome.fna
    
3.4 - Adicionalmente para el llamado de variantes debe obtener un archivo que representará un "diccionario de referencias" del genoma de referencia

    java -jar picard.jar CreateSequenceDictionary R=ref_genome.fna O=ref_genome.dict

La salidad del comando anterior será el archivo

    ref_genome.dict
    
### 4 - Llamado de variantes

4.1 - Añadir grupos de lectura al archivo sort bam

    java -jar picard.jar AddOrReplaceReadGroups I=SRR2006763.sort.bam O=SSRR2006763_sorted_RG.bam ID=sample LB=Paired-end PL=Illumina PU=Unknown SM=sample

4.2 - Indexar archivo generado con Read groups

    samtools index SSRR2006763_sorted_RG.bam

4.3 - Ejecutar el siguiente comando para el llamado de variantes, debe considerar que este proceso demorará al rededor de una hora

    gatk HaplotypeCaller -R ref_genome.fna -I SRR2006763_sorted_RG.bam -O raw_variants.vcf
    
Al culminar la ejecución del comando liste su directorio con ls y verifique que se ha creado su archivo de salida

    raw_variants.vcf

### 5 - Visualización de variantes con IGV

5.1 - Descargue el archivo raw_variants.vcf generado en su directorio "variant_call", 

![Variante SNP localizada en el archivo vcf de la secuencia SRR2006763](https://user-images.githubusercontent.com/80792310/123166136-b1bbd200-d43a-11eb-910c-db6e8d628322.png)



![Zoom a la región seleccionada en el archivo vcf](https://user-images.githubusercontent.com/80792310/123166253-d152fa80-d43a-11eb-838d-8d4f04545664.png)


### 6 - REFERENCIAS

Danecek, P., Auton, A., Abecasis, G., Albers, C., Banks, E., DePristo, M., . . . Durbin, R. (2011). The variant call format and VCFtools. Bioinformatics, 2156–2158.

Deatherage, E. (2020). Genome Analysis Toolkit (GATK). Obtenido de https://wikis.utexas.edu/display/bioiteam/Genome+Analysis+Toolkit+%28GATK%29+.+--+GVA2020

Cingolani, P., Platts, A., Wang, L., Coon, M., Nguyen, T., Wang, L., . . . Ruden, D. (2012). A program for annotating and predicting the effects of single nucleotide polymorphisms, SnpEff. Fly, 80-92.

Liu, X., White, S., Peng, B., Johnson, A., Brody, J., Li, A., . . . Klein, B. E. (2015). WGSA: an annotation pipeline for human genome sequencing studies. JMG, 1-3.

McCormick, R., Truong, S., & Mullet, J. (2015). RIG: Recalibration and Interrelation of Genomic Sequence Data with the GATK. G3: Genes, Genomes, Genetics, 655 - 665.

Tan, Y., Zhang, Y., Yang, H., & Yin, Z. (2020). FPfilter: A false-positive-specific filter for whole-genome sequencing variant calling from GATK. bioRxiv, 1-16.

